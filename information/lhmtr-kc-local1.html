<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>珂华交通局 · 线路详情</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <link rel="stylesheet" type="text/css" href="../assets/css/style.css">
</head>
<body class="bg-gray-100">
    <header class="bg-white shadow-md dark:bg-gray-800 dark:shadow-gray-700 transition-colors">
        <div class="container mx-auto px-4 py-3">
            <div class="flex justify-between items-center">
                <div class="flex items-center">
                    <img src="../assets/images/lhmtrlogo.png" alt="绿海铁道" class="h-12 mr-3">
                    <div>
                        <span class="text-2xl font-bold text-primary dark:text-green-400">绿海铁道</span>
                        <span class="text-2xl font-bold text-primary dark:text-green-400 mx-1">•</span>
                        <span class="text-2xl font-bold text-primary dark:text-green-400">珂华交通局</span>
                        <p class="text-sm text-gray-500 dark:text-gray-400">Minecraft 架空铁道公司</p>
                    </div>
                </div>
                <div class="flex items-center space-x-2">
                    <button id="theme-toggle" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700">
                        <i class="fa fa-sun-o text-xl text-gray-600 dark:hidden"></i>
                        <i class="fa fa-moon-o text-xl text-gray-300 hidden dark:inline-block"></i>
                    </button>
                    <div class="language-switcher">
                        <button id="language-btn" class="language-btn dark:text-gray-300 dark:hover:bg-gray-700">
                            <i class="fa fa-globe"></i><span class="hidden md:inline">语言</span><i class="fa fa-chevron-down ml-1 text-xs"></i>
                        </button>
                        <div id="language-dropdown" class="language-dropdown dark:bg-gray-800 dark:border-gray-700">
                            <a href="#" data-lang="zh-hans"><i class="fa fa-check"></i> 简体中文</a>
                            <a href="#" data-lang="zh-hant"><i class="fa"></i> 繁體中文</a>
                            <a href="#" data-lang="en"><i class="fa"></i> English</a>
                            <a href="#" data-lang="ja"><i class="fa"></i> 日本語</a>
                            <a href="#" data-lang="ko"><i class="fa"></i> 한국어</a>
                        </div>
                    </div>
                    <div class="md:hidden">
                        <button id="mobile-menu-button" class="text-gray-500 hover:text-primary dark:text-gray-400 dark:hover:text-green-400">
                            <i class="fa fa-bars text-xl"></i>
                        </button>
                    </div>
                </div>
            </div>
            <div id="mobile-menu" class="md:hidden hidden pt-3 pb-2 border-t border-gray-200 dark:border-gray-700 mt-2">
                <div class="py-2 px-4 flex items-center justify-between">
                    <span class="text-gray-700 dark:text-gray-300">主题</span>
                    <button id="mobile-theme-toggle" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700">
                        <i class="fa fa-sun-o text-gray-600 dark:hidden"></i>
                        <i class="fa fa-moon-o text-gray-300 hidden dark:inline-block"></i>
                    </button>
                </div>
                <div class="py-2 px-4 flex items-center justify-between">
                    <span class="text-gray-700 dark:text-gray-300">语言</span>
                    <select id="mobile-language-select" class="border rounded p-1 dark:bg-gray-700 dark:text-white dark:border-gray-600">
                        <option value="zh-hans">简体中文</option>
                        <option value="zh-hant">繁體中文</option>
                        <option value="en">English</option>
                        <option value="ja">日本語</option>
                        <option value="ko">한국어</option>
                    </select>
                </div>
            </div>
        </div>
    </header>

    <main class="container mx-auto px-4 py-8">
        <div class="detail-split bg-white shadow-lg">
            <div class="left-panel" id="leftPanel">
                <div id="back-button-container"></div>
            </div>
            <div class="right-panel" id="rightPanel"></div>
        </div>
    </main>

    <footer class="bg-gray-800 text-white py-8">
        <div class="container mx-auto px-4">
            <div class="flex flex-col md:flex-row justify-between items-center">
                <div class="mb-4 md:mb-0">
                    <h3 class="text-xl font-bold mb-2">绿海铁道</h3>
                    <p class="text-gray-400">Minecraft 架空铁道公司</p>
                </div>
                <div class="flex space-x-4">
                    <a href="https://github.com/LHMTR" target="_blank" class="text-gray-400 hover:text-white transition-colors duration-200">
                        <i class="fa fa-github text-xl"></i>
                    </a>
                    <a href="https://gitlab.com/lhmtr" target="_blank" class="text-gray-400 hover:text-white transition-colors duration-200">
                        <i class="fa fa-gitlab text-xl"></i>
                    </a>
                </div>
            </div>
            <div class="mt-6 pt-6 border-t border-gray-700 text-center text-gray-400">
                <p>&copy; 2025 绿海铁道 版权所有</p>
            </div>
        </div>
    </footer>

    <script src="../assets/js/language.js"></script>
    <script>
        (function() {
            const preferredLang = getPreferredLanguage();
            const path = window.location.pathname;
            const lineCode = path.split('/').pop().replace('.html', '');
            const dataUrl = `/information/${lineCode}.json`;

            const backButtonContainer = document.getElementById('back-button-container');
            if (backButtonContainer) {
                backButtonContainer.innerHTML = `
                    <a href="../index_zh-hans.html?lang=${preferredLang}" class="back-button">
                        <i class="fa fa-arrow-left"></i> 返回列表
                    </a>
                `;
            }

            fetch(dataUrl)
                .then(res => res.json())
                .then(data => {
                    renderLeftPanel(data);
                    renderRightPanel(data);
                    setupVariationDropdown(data);
                })
                .catch(err => {
                    document.getElementById('leftPanel').innerHTML += '<p class="error">线路信息加载失败</p>';
                });

            function renderLeftPanel(data) {
                const panel = document.getElementById('leftPanel');
                const lineName = getBilingualText(data.line_name, preferredLang);
                const depot = getBilingualText(data.depot, preferredLang);
                const lineColor = data.color || '#888';
                const noTrain = data.train === false;
                const noTrainMessage = noTrain ? `<div class="no-train-warning"><i class="fa fa-exclamation-triangle"></i> ${getNoTrainMessage(preferredLang)}</div>` : '';

                let html = `
                    <div class="mb-4 text-sm text-gray-500">${getSingleText({ 'zh-hans': '线路信息', 'zh-hant': '線路信息', 'en': 'Route Details', 'ja': '路線詳細', 'ko': '노선 상세' }, preferredLang)}</div>
                    <h1 class="text-3xl font-bold">${lineName.primary}</h1>
                    <div class="text-gray-600 mb-4">${lineName.secondary}</div>
                    ${noTrainMessage}

                    <div class="route-variation-dropdown mb-4" id="variation-container">
                        <button id="variationBtn" class="flex items-center gap-2 border px-4 py-2 rounded hover:bg-gray-100 dark:bg-gray-700 dark:text-white dark:border-gray-600">
                            <span>${getBilingualText(data.service_type, preferredLang).primary} ${getBilingualText(data.service_type, preferredLang).secondary}</span>
                            <i class="fa fa-chevron-down"></i>
                        </button>
                        <div id="variationDropdown" class="dropdown-content dark:bg-gray-800 dark:border-gray-700"></div>
                    </div>

                    <div class="flex items-center gap-2 mb-6 border-t pt-4">
                        <i class="fa fa-home text-gray-500"></i>
                        <span class="font-medium">Depot:</span>
                        <span>${depot.primary}</span>
                        <span class="text-sm text-gray-500">${depot.secondary}</span>
                    </div>

                    <div class="stations-list" style="--line-color: ${lineColor};">
                `;

                const stations = data.stations || {};
                const stationIds = Object.keys(stations).sort((a,b) => stations[a].station_number - stations[b].station_number);
                stationIds.forEach((id, index) => {
                    const s = stations[id];
                    const stationName = getBilingualText(s.station_name, preferredLang);
                    const platform = s.platform || '-';
                    const time = s.time || '-';
                    const lineNumber = s.station_line_number || '';
                    const stationNumber = s.station_number || '';
                    
                    html += `
                        <div class="station-item">
                            <div class="station-dot">
                                <span class="line-number">${lineNumber}</span>
                                <span class="station-number">${stationNumber}</span>
                            </div>
                            ${index < stationIds.length-1 ? '<div class="station-line"></div>' : ''}
                            <div class="station-info">
                                <div>
                                    <div class="station-name">${stationName.primary}</div>
                                    <div class="text-xs text-gray-500">${stationName.secondary}</div>
                                </div>
                                <div class="station-details">
                                    <span>站台 ${platform}</span>
                                    <span>${time}</span>
                                </div>
                            </div>
                        </div>
                    `;
                });

                html += '</div>';
                panel.innerHTML = backButtonContainer.outerHTML + html;
            }

            function renderRightPanel(data) {
                const panel = document.getElementById('rightPanel');
                const intro = getBilingualText(data.introduction, preferredLang);
                panel.innerHTML = `
                    <h2 class="text-xl font-bold mb-4">线路介绍</h2>
                    <p>${intro.primary}</p>
                    <p class="text-sm text-gray-600 mt-2">${intro.secondary}</p>
                `;
            }

            function setupVariationDropdown(data) {
                fetch('/information/index.json')
                    .then(res => res.json())
                    .then(allLines => {
                        const sameLineServices = allLines.filter(item => item.line_code === data.line_code);
                        const dropdown = document.getElementById('variationDropdown');
                        const btn = document.getElementById('variationBtn');
                        if (sameLineServices.length > 1) {
                            let listHtml = '';
                            sameLineServices.forEach(svc => {
                                const svcType = getBilingualText(svc.service_type, preferredLang);
                                listHtml += `<a href="./${svc.line_code}.html?lang=${preferredLang}" class="block px-4 py-2 hover:bg-gray-100 dark:hover:bg-gray-700">${svcType.primary} ${svcType.secondary}</a>`;
                            });
                            dropdown.innerHTML = listHtml;
                            btn.addEventListener('click', (e) => {
                                e.stopPropagation();
                                dropdown.classList.toggle('show');
                            });
                            document.addEventListener('click', () => dropdown.classList.remove('show'));
                        } else {
                            btn.querySelector('i').style.display = 'none';
                        }
                    });
            }

            // 光暗模式切换
            const themeToggle = document.getElementById('theme-toggle');
            const mobileThemeToggle = document.getElementById('mobile-theme-toggle');
            const htmlElement = document.documentElement;
            const savedTheme = localStorage.getItem('theme') || 'light';
            if (savedTheme === 'dark') htmlElement.classList.add('dark');
            function toggleTheme() {
                if (htmlElement.classList.contains('dark')) {
                    htmlElement.classList.remove('dark');
                    localStorage.setItem('theme', 'light');
                } else {
                    htmlElement.classList.add('dark');
                    localStorage.setItem('theme', 'dark');
                }
            }
            if (themeToggle) themeToggle.addEventListener('click', toggleTheme);
            if (mobileThemeToggle) mobileThemeToggle.addEventListener('click', toggleTheme);

            // 移动端菜单
            const mobileMenuButton = document.getElementById('mobile-menu-button');
            const mobileMenu = document.getElementById('mobile-menu');
            if (mobileMenuButton) {
                mobileMenuButton.addEventListener('click', () => mobileMenu.classList.toggle('hidden'));
            }
            const mobileLangSelect = document.getElementById('mobile-language-select');
            if (mobileLangSelect) {
                mobileLangSelect.value = preferredLang;
                mobileLangSelect.addEventListener('change', function() {
                    localStorage.setItem('preferred_lang', this.value);
                    const url = new URL(window.location.href);
                    url.searchParams.set('lang', this.value);
                    window.location.href = url.toString();
                });
            }
        })();
    </script>
</body>
</html>
